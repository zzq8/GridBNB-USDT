# è¶‹åŠ¿è¯†åˆ«æ¨¡å—è®¾è®¡æ–‡æ¡£

> **åˆ›å»ºæ—¥æœŸ**: 2025-10-28
> **ç‰ˆæœ¬**: v1.0.0
> **ä¼˜å…ˆçº§**: ğŸ”´ P0 (é˜¶æ®µ1å…³é”®åŠŸèƒ½)

---

## ğŸ“‹ ç›®å½•

1. [èƒŒæ™¯ä¸åŠ¨æœº](#èƒŒæ™¯ä¸åŠ¨æœº)
2. [åŠŸèƒ½éœ€æ±‚](#åŠŸèƒ½éœ€æ±‚)
3. [æŠ€æœ¯è®¾è®¡](#æŠ€æœ¯è®¾è®¡)
4. [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
5. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
6. [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
7. [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)

---

## èƒŒæ™¯ä¸åŠ¨æœº

### å½“å‰é—®é¢˜

ç½‘æ ¼äº¤æ˜“ç­–ç•¥åœ¨**éœ‡è¡å¸‚**è¡¨ç°ä¼˜ç§€ï¼Œä½†åœ¨**å•è¾¹å¸‚åœº**å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼š

#### âŒ ç‰›å¸‚è¸ç©ºï¼ˆBull Market Missï¼‰

**åœºæ™¯**ï¼šä»·æ ¼æŒç»­ä¸Šæ¶¨
```
åˆå§‹çŠ¶æ€: BNB 600 USDT, æŒä»“ 10 BNB
Day 1: 620 (+3.3%) â†’ ç½‘æ ¼å–å‡º 1 BNB
Day 2: 650 (+8.3%) â†’ ç½‘æ ¼å–å‡º 1 BNB
Day 3: 700 (+16.7%) â†’ ç½‘æ ¼å–å‡º 1 BNB
Day 10: 900 (+50%) â†’ ä»“ä½åªå‰© 3 BNB

ç»“æœå¯¹æ¯”:
- ç½‘æ ¼ç­–ç•¥æ”¶ç›Š: +15% (é¢‘ç¹å–å‡ºï¼Œé”™å¤±å¤§éƒ¨åˆ†æ¶¨å¹…)
- æŒå¸ä¸åŠ¨æ”¶ç›Š: +50% (å®Œå…¨æ•è·è¶‹åŠ¿æ”¶ç›Š)
- æŸå¤±æœºä¼šæˆæœ¬: 35%
```

#### âŒ ç†Šå¸‚æ¥åˆ€ï¼ˆBear Market Trapï¼‰

**åœºæ™¯**ï¼šä»·æ ¼æŒç»­ä¸‹è·Œ
```
åˆå§‹çŠ¶æ€: BNB 600 USDT, 1000 USDT å¯ç”¨
Day 1: 570 (-5%) â†’ ç½‘æ ¼ä¹°å…¥ï¼Œä½¿ç”¨ 200 USDT
Day 2: 540 (-10%) â†’ ç½‘æ ¼ä¹°å…¥ï¼Œä½¿ç”¨ 200 USDT
Day 3: 510 (-15%) â†’ ç½‘æ ¼ä¹°å…¥ï¼Œä½¿ç”¨ 200 USDT
Day 10: 420 (-30%) â†’ èµ„é‡‘è€—å°½ï¼Œæ·±åº¦å¥—ç‰¢

ç»“æœ:
- æŒä»“æˆæœ¬ ~500 USDT
- å½“å‰ä»·æ ¼ 420 USDT
- æµ®äº: -16%
- å‰©ä½™å¯ç”¨èµ„é‡‘: 0 (æ— æ³•åº”å¯¹ç»§ç»­ä¸‹è·Œ)
```

### è§£å†³æ–¹æ¡ˆï¼šè¶‹åŠ¿è¯†åˆ« + ç­–ç•¥è°ƒæ•´

**æ ¸å¿ƒæ€æƒ³**ï¼šè®©ç½‘æ ¼ç­–ç•¥"æ•¬ç•"è¶‹åŠ¿

- **å¼ºä¸Šæ¶¨è¶‹åŠ¿**: æš‚åœæˆ–å‡å°‘å–å‡ºï¼Œä¿æŒä»“ä½äº«å—è¶‹åŠ¿æ”¶ç›Š
- **å¼ºä¸‹è·Œè¶‹åŠ¿**: æš‚åœæˆ–å‡å°‘ä¹°å…¥ï¼Œé¿å…æ·±åº¦å¥—ç‰¢
- **éœ‡è¡å¸‚åœº**: æ­£å¸¸æ‰§è¡Œç½‘æ ¼ç­–ç•¥ï¼Œé«˜æŠ›ä½å¸

---

## åŠŸèƒ½éœ€æ±‚

### æ ¸å¿ƒåŠŸèƒ½

#### 1. è¶‹åŠ¿æ–¹å‘è¯†åˆ«

**å®šä¹‰**ï¼šåˆ¤æ–­å¸‚åœºå½“å‰çš„ä¸»è¦è¿åŠ¨æ–¹å‘

**åˆ†ç±»**:
- `STRONG_UP`: å¼ºä¸Šæ¶¨è¶‹åŠ¿ï¼ˆæŒç»­ä¸Šæ¶¨ï¼Œçªç ´å…³é”®é˜»åŠ›ï¼‰
- `MODERATE_UP`: æ¸©å’Œä¸Šæ¶¨è¶‹åŠ¿
- `SIDEWAYS`: éœ‡è¡æ•´ç†ï¼ˆæ— æ˜ç¡®æ–¹å‘ï¼‰
- `MODERATE_DOWN`: æ¸©å’Œä¸‹è·Œè¶‹åŠ¿
- `STRONG_DOWN`: å¼ºä¸‹è·Œè¶‹åŠ¿ï¼ˆæŒç»­ä¸‹è·Œï¼Œè·Œç ´å…³é”®æ”¯æ’‘ï¼‰

**æŠ€æœ¯æŒ‡æ ‡**ï¼š
```python
# ç»¼åˆå¤šä¸ªæŒ‡æ ‡åˆ¤æ–­
1. EMA åŒçº¿ (20/50):
   - EMA20 > EMA50 ä¸”è·ç¦»æ‰©å¤§ â†’ ä¸Šæ¶¨è¶‹åŠ¿
   - EMA20 < EMA50 ä¸”è·ç¦»æ‰©å¤§ â†’ ä¸‹è·Œè¶‹åŠ¿

2. ADX (å¹³å‡è¶‹å‘æŒ‡æ•°):
   - ADX > 25: è¶‹åŠ¿æ˜æ˜¾
   - ADX > 40: å¼ºè¶‹åŠ¿
   - ADX < 20: æ— è¶‹åŠ¿ï¼ˆéœ‡è¡å¸‚ï¼‰

3. ä»·æ ¼åŠ¨é‡:
   - è¿ç»­Næ ¹Kçº¿æ”¶æ¶¨/è·Œ
   - è¿‘æœŸæ¶¨è·Œå¹…åº¦
```

---

#### 2. è¶‹åŠ¿å¼ºåº¦è¯„åˆ†

**å®šä¹‰**ï¼šé‡åŒ–è¶‹åŠ¿çš„å¼ºå¼±ç¨‹åº¦

**è¯„åˆ†èŒƒå›´**: 0-100
- **0-20**: æå¼±/æ— è¶‹åŠ¿ï¼ˆéœ‡è¡å¸‚ï¼‰
- **20-40**: å¼±è¶‹åŠ¿
- **40-60**: ä¸­ç­‰è¶‹åŠ¿
- **60-80**: å¼ºè¶‹åŠ¿
- **80-100**: æå¼ºè¶‹åŠ¿

**è®¡ç®—æ–¹æ³•**ï¼š
```python
strength_score = (
    adx_score * 0.4 +          # ADX æƒé‡ 40%
    ema_divergence_score * 0.3 +  # EMA åˆ†ç¦»åº¦ æƒé‡ 30%
    momentum_score * 0.2 +     # åŠ¨é‡ æƒé‡ 20%
    volume_score * 0.1         # æˆäº¤é‡ æƒé‡ 10%
)
```

---

#### 3. é£æ§çŠ¶æ€è°ƒæ•´

**å®šä¹‰**ï¼šæ ¹æ®è¶‹åŠ¿è°ƒæ•´äº¤æ˜“é™åˆ¶

**é£æ§çŠ¶æ€æ˜ å°„**:
```python
if trend == STRONG_UP and strength > 60:
    â†’ RiskState.ALLOW_BUY_ONLY  # æš‚åœå–å‡º

elif trend == STRONG_DOWN and strength > 60:
    â†’ RiskState.ALLOW_SELL_ONLY  # æš‚åœä¹°å…¥

else:
    â†’ RiskState.ALLOW_ALL  # æ­£å¸¸äº¤æ˜“
```

**é‡è¦**: è¶‹åŠ¿é£æ§ä¼˜å…ˆçº§**é«˜äº**ä»“ä½é£æ§

---

## æŠ€æœ¯è®¾è®¡

### ç±»ç»“æ„

```python
from enum import Enum
from dataclasses import dataclass
from typing import Dict, List, Optional

class TrendDirection(Enum):
    """è¶‹åŠ¿æ–¹å‘"""
    STRONG_UP = "strong_up"
    MODERATE_UP = "moderate_up"
    SIDEWAYS = "sideways"
    MODERATE_DOWN = "moderate_down"
    STRONG_DOWN = "strong_down"

@dataclass
class TrendSignal:
    """è¶‹åŠ¿ä¿¡å·"""
    direction: TrendDirection
    strength: float  # 0-100
    confidence: float  # 0-1ï¼Œç½®ä¿¡åº¦
    timestamp: float
    indicators: Dict[str, float]  # å„æŒ‡æ ‡å€¼
    reason: str  # åˆ¤æ–­ç†ç”±

class TrendDetector:
    """
    è¶‹åŠ¿è¯†åˆ«å™¨

    èŒè´£:
    1. åˆ†æå¸‚åœºæ•°æ®ï¼Œè¯†åˆ«è¶‹åŠ¿æ–¹å‘
    2. è®¡ç®—è¶‹åŠ¿å¼ºåº¦è¯„åˆ†
    3. æä¾›äº¤æ˜“å»ºè®®ï¼ˆæš‚åœä¹°å…¥/å–å‡ºï¼‰
    4. ç¼“å­˜å’Œæ›´æ–°è¶‹åŠ¿çŠ¶æ€
    """

    def __init__(
        self,
        symbol: str,
        ema_short: int = 20,
        ema_long: int = 50,
        adx_period: int = 14,
        strong_trend_threshold: float = 60.0,
        cache_ttl: int = 300  # 5åˆ†é’Ÿç¼“å­˜
    ):
        self.symbol = symbol
        self.ema_short = ema_short
        self.ema_long = ema_long
        self.adx_period = adx_period
        self.strong_trend_threshold = strong_trend_threshold

        # ç¼“å­˜
        self.last_signal: Optional[TrendSignal] = None
        self.last_update: float = 0
        self.cache_ttl = cache_ttl

    async def detect_trend(
        self,
        exchange: IExchange
    ) -> TrendSignal:
        """
        æ£€æµ‹å½“å‰è¶‹åŠ¿

        Args:
            exchange: äº¤æ˜“æ‰€å®¢æˆ·ç«¯

        Returns:
            TrendSignal: è¶‹åŠ¿ä¿¡å·å¯¹è±¡
        """

    def should_pause_buy(self, signal: TrendSignal) -> bool:
        """åˆ¤æ–­æ˜¯å¦åº”æš‚åœä¹°å…¥"""

    def should_pause_sell(self, signal: TrendSignal) -> bool:
        """åˆ¤æ–­æ˜¯å¦åº”æš‚åœå–å‡º"""

    def get_risk_state(self, signal: TrendSignal) -> RiskState:
        """è·å–å»ºè®®çš„é£æ§çŠ¶æ€"""
```

### æ•°æ®æµ

```mermaid
graph TD
    A[GridTrader.main_loop] --> B[TrendDetector.detect_trend]
    B --> C[è·å–å†å²Kçº¿æ•°æ®]
    C --> D[è®¡ç®—æŠ€æœ¯æŒ‡æ ‡]
    D --> E[EMA 20/50]
    D --> F[ADX]
    D --> G[ä»·æ ¼åŠ¨é‡]
    D --> H[æˆäº¤é‡åˆ†æ]

    E --> I[ç»¼åˆåˆ¤æ–­è¶‹åŠ¿æ–¹å‘]
    F --> I
    G --> I
    H --> I

    I --> J[è®¡ç®—è¶‹åŠ¿å¼ºåº¦]
    J --> K[ç”Ÿæˆ TrendSignal]
    K --> L[æ›´æ–°é£æ§çŠ¶æ€]
    L --> M[GridTrader æ ¹æ®çŠ¶æ€å†³ç­–]
```

### çŠ¶æ€æœº

```
SIDEWAYS (éœ‡è¡å¸‚)
    â†“ (EMAé‡‘å‰ + ADXä¸Šå‡)
MODERATE_UP (æ¸©å’Œä¸Šæ¶¨)
    â†“ (åŠ¨é‡åŠ é€Ÿ + æˆäº¤é‡æ”¾å¤§)
STRONG_UP (å¼ºä¸Šæ¶¨) â†’ [æš‚åœå–å‡º]
    â†“ (åŠ¨é‡è¡°å‡)
MODERATE_UP (æ¸©å’Œä¸Šæ¶¨)
    â†“ (EMAæ­»å‰)
SIDEWAYS (éœ‡è¡å¸‚)
    â†“ (EMAæ­»å‰ + ADXä¸Šå‡)
MODERATE_DOWN (æ¸©å’Œä¸‹è·Œ)
    â†“ (åŠ¨é‡åŠ é€Ÿ + æˆäº¤é‡æ”¾å¤§)
STRONG_DOWN (å¼ºä¸‹è·Œ) â†’ [æš‚åœä¹°å…¥]
```

---

## å®ç°ç»†èŠ‚

### 1. æ ¸å¿ƒæ–¹æ³•å®ç°

#### 1.1 è¶‹åŠ¿æ£€æµ‹æ–¹æ³•

```python
async def detect_trend(
    self,
    exchange: IExchange
) -> TrendSignal:
    """æ£€æµ‹å½“å‰è¶‹åŠ¿"""

    # 1. æ£€æŸ¥ç¼“å­˜
    if self._is_cache_valid():
        return self.last_signal

    # 2. è·å–Kçº¿æ•°æ®ï¼ˆ4å°æ—¶çº§åˆ«ï¼Œæœ€è¿‘100æ ¹ï¼‰
    ohlcv = await exchange.fetch_ohlcv(
        self.symbol,
        timeframe='4h',
        limit=100
    )

    # 3. è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
    indicators = await self._calculate_indicators(ohlcv)

    # 4. åˆ¤æ–­è¶‹åŠ¿æ–¹å‘
    direction = self._determine_direction(indicators)

    # 5. è®¡ç®—è¶‹åŠ¿å¼ºåº¦
    strength = self._calculate_strength(indicators)

    # 6. è®¡ç®—ç½®ä¿¡åº¦
    confidence = self._calculate_confidence(indicators)

    # 7. ç”Ÿæˆåˆ¤æ–­ç†ç”±
    reason = self._generate_reason(direction, strength, indicators)

    # 8. åˆ›å»ºè¶‹åŠ¿ä¿¡å·
    signal = TrendSignal(
        direction=direction,
        strength=strength,
        confidence=confidence,
        timestamp=time.time(),
        indicators=indicators,
        reason=reason
    )

    # 9. æ›´æ–°ç¼“å­˜
    self.last_signal = signal
    self.last_update = time.time()

    return signal
```

#### 1.2 æŠ€æœ¯æŒ‡æ ‡è®¡ç®—

```python
async def _calculate_indicators(
    self,
    ohlcv: List[List[float]]
) -> Dict[str, float]:
    """è®¡ç®—æŠ€æœ¯æŒ‡æ ‡"""

    closes = np.array([candle[4] for candle in ohlcv])
    highs = np.array([candle[2] for candle in ohlcv])
    lows = np.array([candle[3] for candle in ohlcv])
    volumes = np.array([candle[5] for candle in ohlcv])

    # 1. EMA è®¡ç®—
    ema_short = self._calculate_ema(closes, self.ema_short)
    ema_long = self._calculate_ema(closes, self.ema_long)

    # EMA åˆ†ç¦»åº¦ï¼ˆæ ‡å‡†åŒ–ï¼‰
    ema_divergence = (ema_short[-1] - ema_long[-1]) / ema_long[-1]

    # 2. ADX è®¡ç®—
    adx = self._calculate_adx(highs, lows, closes, self.adx_period)

    # 3. åŠ¨é‡è®¡ç®—
    momentum = self._calculate_momentum(closes, period=14)

    # 4. æˆäº¤é‡åˆ†æ
    volume_ma = np.mean(volumes[-20:])
    current_volume = volumes[-1]
    volume_ratio = current_volume / volume_ma

    # 5. è¿ç»­æ¶¨è·Œè®¡æ•°
    consecutive_ups = self._count_consecutive(closes, direction='up')
    consecutive_downs = self._count_consecutive(closes, direction='down')

    return {
        'ema_short': ema_short[-1],
        'ema_long': ema_long[-1],
        'ema_divergence': ema_divergence,
        'adx': adx[-1],
        'momentum': momentum[-1],
        'volume_ratio': volume_ratio,
        'consecutive_ups': consecutive_ups,
        'consecutive_downs': consecutive_downs,
        'current_price': closes[-1]
    }
```

#### 1.3 è¶‹åŠ¿æ–¹å‘åˆ¤æ–­

```python
def _determine_direction(
    self,
    indicators: Dict[str, float]
) -> TrendDirection:
    """åˆ¤æ–­è¶‹åŠ¿æ–¹å‘"""

    ema_div = indicators['ema_divergence']
    adx = indicators['adx']
    momentum = indicators['momentum']
    consecutive_ups = indicators['consecutive_ups']
    consecutive_downs = indicators['consecutive_downs']

    # å¼ºä¸Šæ¶¨è¶‹åŠ¿æ¡ä»¶
    if (ema_div > 0.02 and  # EMA ä¸Šç©¿ 2%ä»¥ä¸Š
        adx > 40 and  # ADX å¼ºè¶‹åŠ¿
        momentum > 5 and  # åŠ¨é‡å¼º
        consecutive_ups >= 3):  # è¿ç»­3æ ¹ä¸Šæ¶¨
        return TrendDirection.STRONG_UP

    # æ¸©å’Œä¸Šæ¶¨è¶‹åŠ¿
    elif ema_div > 0.005 and adx > 25:
        return TrendDirection.MODERATE_UP

    # å¼ºä¸‹è·Œè¶‹åŠ¿
    elif (ema_div < -0.02 and
          adx > 40 and
          momentum < -5 and
          consecutive_downs >= 3):
        return TrendDirection.STRONG_DOWN

    # æ¸©å’Œä¸‹è·Œè¶‹åŠ¿
    elif ema_div < -0.005 and adx > 25:
        return TrendDirection.MODERATE_DOWN

    # éœ‡è¡å¸‚åœº
    else:
        return TrendDirection.SIDEWAYS
```

#### 1.4 è¶‹åŠ¿å¼ºåº¦è®¡ç®—

```python
def _calculate_strength(
    self,
    indicators: Dict[str, float]
) -> float:
    """è®¡ç®—è¶‹åŠ¿å¼ºåº¦ï¼ˆ0-100ï¼‰"""

    # 1. ADX è¯„åˆ†ï¼ˆ0-50ï¼‰
    adx = min(indicators['adx'], 100)
    adx_score = (adx / 100) * 50

    # 2. EMA åˆ†ç¦»åº¦è¯„åˆ†ï¼ˆ0-30ï¼‰
    ema_div = abs(indicators['ema_divergence'])
    ema_score = min(ema_div * 500, 30)  # 6%åˆ†ç¦»åº¦ = æ»¡åˆ†30

    # 3. åŠ¨é‡è¯„åˆ†ï¼ˆ0-15ï¼‰
    momentum = abs(indicators['momentum'])
    momentum_score = min(momentum / 10 * 15, 15)

    # 4. æˆäº¤é‡è¯„åˆ†ï¼ˆ0-5ï¼‰
    volume_ratio = indicators['volume_ratio']
    volume_score = min((volume_ratio - 1) * 5, 5)

    # æ€»åˆ†
    total_score = adx_score + ema_score + momentum_score + volume_score

    return min(max(total_score, 0), 100)
```

#### 1.5 äº¤æ˜“å»ºè®®æ–¹æ³•

```python
def should_pause_buy(self, signal: TrendSignal) -> bool:
    """åˆ¤æ–­æ˜¯å¦åº”æš‚åœä¹°å…¥"""
    return (
        signal.direction == TrendDirection.STRONG_DOWN and
        signal.strength > self.strong_trend_threshold and
        signal.confidence > 0.7
    )

def should_pause_sell(self, signal: TrendSignal) -> bool:
    """åˆ¤æ–­æ˜¯å¦åº”æš‚åœå–å‡º"""
    return (
        signal.direction == TrendDirection.STRONG_UP and
        signal.strength > self.strong_trend_threshold and
        signal.confidence > 0.7
    )

def get_risk_state(self, signal: TrendSignal) -> RiskState:
    """è·å–å»ºè®®çš„é£æ§çŠ¶æ€"""
    if self.should_pause_buy(signal):
        return RiskState.ALLOW_SELL_ONLY
    elif self.should_pause_sell(signal):
        return RiskState.ALLOW_BUY_ONLY
    else:
        return RiskState.ALLOW_ALL
```

### 2. é›†æˆåˆ° GridTrader

#### 2.1 åˆå§‹åŒ–

```python
class GridTrader:
    def __init__(self, ...):
        # ... ç°æœ‰ä»£ç  ...

        # ğŸ†• è¶‹åŠ¿è¯†åˆ«å™¨
        self.trend_detector = TrendDetector(
            symbol=self.symbol,
            ema_short=settings.TREND_EMA_SHORT,
            ema_long=settings.TREND_EMA_LONG,
            adx_period=settings.TREND_ADX_PERIOD,
            strong_trend_threshold=settings.TREND_STRONG_THRESHOLD
        )

        self.current_trend: Optional[TrendSignal] = None
```

#### 2.2 ä¸»å¾ªç¯é›†æˆ

```python
async def main_loop(self):
    while True:
        try:
            # ... ç°æœ‰çš„åˆå§‹åŒ–å’Œä»·æ ¼è·å– ...

            # ğŸ†• è¶‹åŠ¿æ£€æµ‹ï¼ˆæ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ï¼Œæœ‰ç¼“å­˜ï¼‰
            if settings.ENABLE_TREND_DETECTION:
                self.current_trend = await self.trend_detector.detect_trend(
                    self.exchange
                )

                # æ ¹æ®è¶‹åŠ¿è°ƒæ•´é£æ§çŠ¶æ€
                trend_risk_state = self.trend_detector.get_risk_state(
                    self.current_trend
                )

                # è¶‹åŠ¿é£æ§ä¼˜å…ˆçº§é«˜äºä»“ä½é£æ§
                if trend_risk_state != RiskState.ALLOW_ALL:
                    self.risk_manager.override_risk_state(trend_risk_state)

                    self.logger.info(
                        "trend_override",
                        trend=self.current_trend.direction.value,
                        strength=self.current_trend.strength,
                        risk_state=trend_risk_state.value,
                        reason=self.current_trend.reason
                    )

            # ... åç»­çš„äº¤æ˜“ä¿¡å·æ£€æµ‹å’Œæ‰§è¡Œ ...

        except Exception as e:
            # ... é”™è¯¯å¤„ç† ...
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡ï¼ˆ.envï¼‰

```bash
# ========== è¶‹åŠ¿è¯†åˆ«é…ç½® (Trend Detection Settings) ==========
# æ˜¯å¦å¯ç”¨è¶‹åŠ¿è¯†åˆ«ï¼ˆtrue/falseï¼‰
# å¯ç”¨åï¼Œç³»ç»Ÿä¼šæ ¹æ®å¸‚åœºè¶‹åŠ¿è‡ªåŠ¨è°ƒæ•´äº¤æ˜“ç­–ç•¥
# å¼ºä¸Šæ¶¨è¶‹åŠ¿æ—¶å‡å°‘å–å‡ºï¼Œå¼ºä¸‹è·Œè¶‹åŠ¿æ—¶å‡å°‘ä¹°å…¥
ENABLE_TREND_DETECTION=true

# EMA çŸ­å‘¨æœŸï¼ˆå»ºè®®: 10-30ï¼‰
# ç”¨äºå¿«é€Ÿæ•æ‰ä»·æ ¼å˜åŒ–
TREND_EMA_SHORT=20

# EMA é•¿å‘¨æœŸï¼ˆå»ºè®®: 30-100ï¼‰
# ç”¨äºåˆ¤æ–­é•¿æœŸè¶‹åŠ¿æ–¹å‘
TREND_EMA_LONG=50

# ADX è®¡ç®—å‘¨æœŸï¼ˆå»ºè®®: 14ï¼‰
# ADX æ˜¯è¡¡é‡è¶‹åŠ¿å¼ºåº¦çš„æ ‡å‡†æŒ‡æ ‡
TREND_ADX_PERIOD=14

# å¼ºè¶‹åŠ¿é˜ˆå€¼ï¼ˆ0-100ï¼Œå»ºè®®: 50-70ï¼‰
# è¶…è¿‡æ­¤é˜ˆå€¼æ‰è®¤ä¸ºæ˜¯å¼ºè¶‹åŠ¿ï¼Œä¼šè§¦å‘äº¤æ˜“é™åˆ¶
# ä¿å®ˆ: 50ï¼Œå¹³è¡¡: 60ï¼Œæ¿€è¿›: 70
TREND_STRONG_THRESHOLD=60.0

# è¶‹åŠ¿æ£€æµ‹é—´éš”ï¼ˆç§’ï¼Œå»ºè®®: 300-600ï¼‰
# è¶‹åŠ¿åˆ¤æ–­çš„ç¼“å­˜æ—¶é—´ï¼Œé¿å…è¿‡äºé¢‘ç¹è®¡ç®—
TREND_DETECTION_INTERVAL=300
```

### Settings.py é…ç½®

```python
class Settings(BaseSettings):
    # ... ç°æœ‰é…ç½® ...

    # è¶‹åŠ¿è¯†åˆ«é…ç½®
    ENABLE_TREND_DETECTION: bool = True  # é»˜è®¤å¯ç”¨
    TREND_EMA_SHORT: int = 20
    TREND_EMA_LONG: int = 50
    TREND_ADX_PERIOD: int = 14
    TREND_STRONG_THRESHOLD: float = 60.0
    TREND_DETECTION_INTERVAL: int = 300  # 5åˆ†é’Ÿ

    @field_validator('TREND_EMA_SHORT', 'TREND_EMA_LONG')
    @classmethod
    def validate_ema_periods(cls, v, info):
        field_name = info.field_name
        if v < 5 or v > 200:
            raise ValueError(f"{field_name} å¿…é¡»åœ¨ 5-200 ä¹‹é—´")
        return v

    @field_validator('TREND_STRONG_THRESHOLD')
    @classmethod
    def validate_trend_threshold(cls, v):
        if v < 0 or v > 100:
            raise ValueError("TREND_STRONG_THRESHOLD å¿…é¡»åœ¨ 0-100 ä¹‹é—´")
        if v < 40:
            logging.warning("TREND_STRONG_THRESHOLD è¿‡ä½å¯èƒ½å¯¼è‡´è¿‡åº¦é™åˆ¶äº¤æ˜“")
        return v
```

---

## æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

```python
# tests/unit/test_trend_detector.py

class TestTrendDetector:
    """è¶‹åŠ¿è¯†åˆ«å™¨å•å…ƒæµ‹è¯•"""

    def test_strong_uptrend_detection(self):
        """æµ‹è¯•å¼ºä¸Šæ¶¨è¶‹åŠ¿è¯†åˆ«"""

    def test_strong_downtrend_detection(self):
        """æµ‹è¯•å¼ºä¸‹è·Œè¶‹åŠ¿è¯†åˆ«"""

    def test_sideways_detection(self):
        """æµ‹è¯•éœ‡è¡å¸‚è¯†åˆ«"""

    def test_ema_calculation(self):
        """æµ‹è¯•EMAè®¡ç®—å‡†ç¡®æ€§"""

    def test_adx_calculation(self):
        """æµ‹è¯•ADXè®¡ç®—å‡†ç¡®æ€§"""

    def test_strength_scoring(self):
        """æµ‹è¯•è¶‹åŠ¿å¼ºåº¦è¯„åˆ†"""

    def test_should_pause_buy(self):
        """æµ‹è¯•ä¹°å…¥æš‚åœåˆ¤æ–­"""

    def test_should_pause_sell(self):
        """æµ‹è¯•å–å‡ºæš‚åœåˆ¤æ–­"""

    def test_cache_mechanism(self):
        """æµ‹è¯•ç¼“å­˜æœºåˆ¶"""

    def test_risk_state_override(self):
        """æµ‹è¯•é£æ§çŠ¶æ€è¦†ç›–"""
```

### é›†æˆæµ‹è¯•åœºæ™¯

#### åœºæ™¯1ï¼šå¼ºä¸Šæ¶¨è¶‹åŠ¿

```python
# æ¨¡æ‹Ÿå¼ºç‰›å¸‚
ä»·æ ¼åºåˆ—: 600 â†’ 620 â†’ 650 â†’ 680 â†’ 720 â†’ 780

é¢„æœŸè¡Œä¸º:
1. è¯†åˆ« STRONG_UP è¶‹åŠ¿
2. å¼ºåº¦è¯„åˆ† > 60
3. æš‚åœå–å‡ºæ“ä½œ
4. ä¿æŒä»“ä½ä¸åŠ¨
5. è®°å½•æ—¥å¿—

éªŒè¯:
âœ… TrendSignal.direction == STRONG_UP
âœ… TrendSignal.strength > 60
âœ… should_pause_sell() == True
âœ… RiskState == ALLOW_BUY_ONLY
âœ… å®é™…æœªæ‰§è¡Œå–å‡ºæ“ä½œ
```

#### åœºæ™¯2ï¼šå¼ºä¸‹è·Œè¶‹åŠ¿

```python
# æ¨¡æ‹Ÿç†Šå¸‚
ä»·æ ¼åºåˆ—: 600 â†’ 580 â†’ 550 â†’ 520 â†’ 480 â†’ 420

é¢„æœŸè¡Œä¸º:
1. è¯†åˆ« STRONG_DOWN è¶‹åŠ¿
2. å¼ºåº¦è¯„åˆ† > 60
3. æš‚åœä¹°å…¥æ“ä½œ
4. é¿å…æŒç»­æ¥åˆ€
5. è®°å½•æ—¥å¿—

éªŒè¯:
âœ… TrendSignal.direction == STRONG_DOWN
âœ… TrendSignal.strength > 60
âœ… should_pause_buy() == True
âœ… RiskState == ALLOW_SELL_ONLY
âœ… å®é™…æœªæ‰§è¡Œä¹°å…¥æ“ä½œ
```

#### åœºæ™¯3ï¼šéœ‡è¡å¸‚åœº

```python
# æ¨¡æ‹Ÿéœ‡è¡
ä»·æ ¼åºåˆ—: 600 â†’ 610 â†’ 595 â†’ 605 â†’ 590 â†’ 600

é¢„æœŸè¡Œä¸º:
1. è¯†åˆ« SIDEWAYS è¶‹åŠ¿
2. å¼ºåº¦è¯„åˆ† < 40
3. æ­£å¸¸æ‰§è¡Œç½‘æ ¼ç­–ç•¥
4. é«˜æŠ›ä½å¸

éªŒè¯:
âœ… TrendSignal.direction == SIDEWAYS
âœ… TrendSignal.strength < 40
âœ… RiskState == ALLOW_ALL
âœ… ä¹°å–æ“ä½œæ­£å¸¸æ‰§è¡Œ
```

### å†å²æ•°æ®å›æµ‹

**å›æµ‹å‘¨æœŸ**: 2024å¹´1æœˆ-2024å¹´10æœˆï¼ˆè¦†ç›–ç‰›å¸‚+ç†Šå¸‚ï¼‰

**å›æµ‹äº¤æ˜“å¯¹**: BNB/USDT, ETH/USDT, BTC/USDT

**å¯¹æ¯”ç»„**:
1. çº¯ç½‘æ ¼ç­–ç•¥ï¼ˆæ— è¶‹åŠ¿è¯†åˆ«ï¼‰
2. ç½‘æ ¼+è¶‹åŠ¿è¯†åˆ«ç­–ç•¥
3. ç®€å•æŒå¸ç­–ç•¥

**è¯„ä¼°æŒ‡æ ‡**:
- æ€»æ”¶ç›Šç‡
- æœ€å¤§å›æ’¤
- å¤æ™®æ¯”ç‡
- èƒœç‡
- äº¤æ˜“æ¬¡æ•°

---

## æ€§èƒ½è€ƒè™‘

### è®¡ç®—æ€§èƒ½

**ä¼˜åŒ–æªæ–½**:

1. **ç¼“å­˜æœºåˆ¶**: 5åˆ†é’Ÿç¼“å­˜ï¼Œé¿å…é¢‘ç¹è®¡ç®—
2. **æ‰¹é‡è®¡ç®—**: ä½¿ç”¨ numpy å‘é‡åŒ–è¿ç®—
3. **å¼‚æ­¥éé˜»å¡**: æ‰€æœ‰I/Oæ“ä½œå¼‚æ­¥æ‰§è¡Œ
4. **æ•°æ®é‡æ§åˆ¶**: åªè·å–å¿…è¦çš„100æ ¹Kçº¿

**é¢„æœŸæ€§èƒ½**:
- å•æ¬¡è¶‹åŠ¿æ£€æµ‹è€—æ—¶: < 500ms
- ç¼“å­˜å‘½ä¸­ç‡: > 95%
- å¯¹ä¸»å¾ªç¯å½±å“: < 1%

### å†…å­˜ä½¿ç”¨

**é¢„ä¼°å†…å­˜å ç”¨**:
- Kçº¿æ•°æ®ï¼ˆ100æ ¹ * 6å­—æ®µ * 8å­—èŠ‚ï¼‰: ~5 KB
- è®¡ç®—ä¸­é—´ç»“æœ: ~2 KB
- ç¼“å­˜å¯¹è±¡: ~1 KB
- **æ€»è®¡**: ~8 KB per symbol

---

## é£é™©ä¸æ³¨æ„äº‹é¡¹

### âš ï¸ æ½œåœ¨é£é™©

1. **è¶‹åŠ¿è¯¯åˆ¤**
   - é£é™©: éœ‡è¡å¸‚è¯¯åˆ¤ä¸ºè¶‹åŠ¿ï¼Œè¿‡åº¦é™åˆ¶äº¤æ˜“
   - ç¼“è§£: æé«˜å¼ºè¶‹åŠ¿é˜ˆå€¼ï¼Œå¢åŠ ç½®ä¿¡åº¦åˆ¤æ–­

2. **è¶‹åŠ¿è½¬æ¢å»¶è¿Ÿ**
   - é£é™©: è¶‹åŠ¿åè½¬æ—¶ï¼Œåˆ¤æ–­æœ‰å»¶è¿Ÿ
   - ç¼“è§£: ä½¿ç”¨å¤šå‘¨æœŸç¡®è®¤ï¼Œé™ä½ç¼“å­˜æ—¶é—´

3. **å‚æ•°æ•æ„Ÿæ€§**
   - é£é™©: ä¸åŒå¸‚åœº/äº¤æ˜“å¯¹æœ€ä¼˜å‚æ•°ä¸åŒ
   - ç¼“è§£: æä¾›å¯é…ç½®å‚æ•°ï¼Œå»ºè®®å›æµ‹ä¼˜åŒ–

4. **å‡çªç ´**
   - é£é™©: çŸ­æœŸå†²é«˜å›è½è¢«è¯¯åˆ¤ä¸ºè¶‹åŠ¿
   - ç¼“è§£: å¢åŠ ç¡®è®¤æ¡ä»¶ï¼ˆè¿ç»­Kçº¿ã€æˆäº¤é‡ï¼‰

### âœ… ç¼“è§£æªæ–½

1. **å¤šæŒ‡æ ‡ç»¼åˆåˆ¤æ–­**: ä¸ä¾èµ–å•ä¸€æŒ‡æ ‡
2. **ç½®ä¿¡åº¦é—¨æ§›**: ä½ç½®ä¿¡åº¦ä¿¡å·ä¸æ‰§è¡Œé™åˆ¶
3. **æ¸è¿›å¼è°ƒæ•´**: ä»æ¸©å’Œè¶‹åŠ¿åˆ°å¼ºè¶‹åŠ¿ï¼Œé€æ­¥é™åˆ¶
4. **äººå·¥ç›‘ç£**: é‡è¦è¶‹åŠ¿è½¬æ¢æ—¶å‘é€é€šçŸ¥

---

## å®æ–½æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µ

- [ ] åˆ›å»º `src/strategies/trend_detector.py`
- [ ] å®ç° `TrendDetector` ç±»
- [ ] å®ç° EMA è®¡ç®—æ–¹æ³•
- [ ] å®ç° ADX è®¡ç®—æ–¹æ³•
- [ ] å®ç°è¶‹åŠ¿æ–¹å‘åˆ¤æ–­é€»è¾‘
- [ ] å®ç°è¶‹åŠ¿å¼ºåº¦è®¡ç®—é€»è¾‘
- [ ] å®ç°ç¼“å­˜æœºåˆ¶

### é›†æˆé˜¶æ®µ

- [ ] é›†æˆåˆ° `GridTrader.__init__()`
- [ ] é›†æˆåˆ° `GridTrader.main_loop()`
- [ ] æ·»åŠ é£æ§çŠ¶æ€è¦†ç›–é€»è¾‘
- [ ] æ·»åŠ æ—¥å¿—è®°å½•
- [ ] æ·»åŠ é…ç½®é¡¹åˆ° `.env.example`
- [ ] æ·»åŠ é…ç½®é¡¹åˆ° `settings.py`
- [ ] æ·»åŠ é…ç½®éªŒè¯å™¨

### æµ‹è¯•é˜¶æ®µ

- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆè‡³å°‘10ä¸ªï¼‰
- [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆ3ä¸ªåœºæ™¯ï¼‰
- [ ] å†å²æ•°æ®å›æµ‹
- [ ] å‚æ•°è°ƒä¼˜
- [ ] æ€§èƒ½æµ‹è¯•

### æ–‡æ¡£é˜¶æ®µ

- [ ] å®Œå–„ä»£ç æ³¨é‡Š
- [ ] æ›´æ–° ROADMAP.md
- [ ] æ›´æ–° CLAUDE.md
- [ ] ç¼–å†™ç”¨æˆ·ä½¿ç”¨æŒ‡å—
- [ ] ç¼–å†™å‚æ•°è°ƒä¼˜æŒ‡å—

---

## é™„å½•

### A. æŠ€æœ¯æŒ‡æ ‡å…¬å¼

#### EMA (æŒ‡æ•°ç§»åŠ¨å¹³å‡)

```python
EMA_t = Î± * Price_t + (1 - Î±) * EMA_{t-1}

å…¶ä¸­ Î± = 2 / (period + 1)
```

#### ADX (å¹³å‡è¶‹å‘æŒ‡æ•°)

```python
# 1. è®¡ç®— +DI å’Œ -DI
+DM = max(High_t - High_{t-1}, 0)
-DM = max(Low_{t-1} - Low_t, 0)

TR = max(High_t - Low_t, |High_t - Close_{t-1}|, |Low_t - Close_{t-1}|)

+DI = EMA(+DM / TR) * 100
-DI = EMA(-DM / TR) * 100

# 2. è®¡ç®— DX
DX = |+DI - -DI| / (+DI + -DI) * 100

# 3. è®¡ç®— ADX
ADX = EMA(DX)
```

### B. å‚è€ƒèµ„æ–™

1. **EMA æŒ‡æ ‡**: https://www.investopedia.com/terms/e/ema.asp
2. **ADX æŒ‡æ ‡**: https://www.investopedia.com/terms/a/adx.asp
3. **è¶‹åŠ¿äº¤æ˜“ç­–ç•¥**: Trading Systems and Methods (Perry Kaufman)
4. **æŠ€æœ¯åˆ†æåŸºç¡€**: Technical Analysis of the Financial Markets (John Murphy)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-10-28
**ä½œè€…**: GridBNB-USDT Team
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
