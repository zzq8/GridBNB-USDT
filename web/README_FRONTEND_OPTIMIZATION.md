# GridBNB 前端优化文档

## 📋 Phase 1: 数据可视化图表 ✅ (已完成)

### 已完成功能

1. **集成 ECharts 图表库**
   - 添加了 `echarts` 和 `echarts-for-react` 依赖
   - 支持亮色/暗色主题自动切换

2. **创建了3个可复用图表组件**：
   - `ProfitTrendChart` - 盈亏趋势折线图
   - `TradeVolumeChart` - 交易量分布柱状图
   - `PositionPieChart` - 仓位分布饼图

3. **更新Home页面**：
   - 在首页添加了"数据可视化"卡片
   - 使用Tabs切换不同图表视图
   - 自动从API数据生成图表数据

### 安装依赖

```bash
cd web
npm install
```

新增依赖：
- `echarts@^5.5.0` - ECharts 图表库
- `echarts-for-react@^3.0.2` - React ECharts 封装

### 本地开发

```bash
cd web
npm run dev
```

访问: `http://localhost:5173`

### 构建生产版本

```bash
cd web
npm run build
```

构建输出到 `web/dist/` 目录

### 文件结构

```
web/src/
├── components/
│   └── charts/           # 图表组件 (新增)
│       ├── ProfitTrendChart.tsx       # 盈亏趋势图
│       ├── TradeVolumeChart.tsx       # 交易量分布图
│       ├── PositionPieChart.tsx       # 仓位分布图
│       └── index.ts                    # 导出文件
├── pages/
│   └── Home/
│       └── index.tsx     # 首页 (已更新 - 集成图表)
```

### 图表功能特性

#### 1. 盈亏趋势图
- ✅ 显示最近24小时盈亏变化
- ✅ 渐变填充区域
- ✅ 鼠标悬停显示详细数据
- ✅ 自适应亮色/暗色主题

#### 2. 交易量分布图
- ✅ 按交易对显示买入/卖出量
- ✅ 双柱状图对比
- ✅ 交易对标签自动旋转（支持多交易对）

#### 3. 仓位分布图
- ✅ 环形饼图展示
- ✅ 鼠标悬停强调选中项
- ✅ 百分比自动计算

### 数据来源

当前版本：
- 📊 **盈亏趋势**：根据当前总盈亏模拟生成24小时数据
- 📊 **交易量**：随机生成（演示用）
- 📊 **仓位分布**：基于API返回的实时仓位数据计算

后续优化：
- 🔄 后端API需要提供真实的历史数据接口
- 🔄 实现SSE实时推送，图表数据动态更新

### 已知限制

1. **历史数据**：当前使用模拟数据，需要后端API支持
2. **性能优化**：大数据量时可能需要图表优化（如数据采样）
3. **交互功能**：可以添加更多图表交互（如缩放、数据导出等）

---

## 📋 Phase 2: 日志查看器 ✅ (已完成)

### 已完成功能

1. **后端日志API** (`src/fastapi_app/routers/logs.py`)
   - 日志列表查询（支持分页）
   - 日志文件列表
   - 日志级别筛选（DEBUG/INFO/WARNING/ERROR/CRITICAL）
   - 关键字搜索
   - 实时日志流（SSE）

2. **前端日志查看页面** (`web/src/pages/Logs/index.tsx`)
   - 日志表格展示
   - 日志级别筛选器
   - 关键字搜索框
   - 日志文件切换
   - 自动刷新功能（每5秒）
   - 日志导出功能

3. **路由和菜单集成**
   - 添加 `/logs` 路由
   - 侧边栏菜单新增"日志查看"项

### 文件结构

```
src/fastapi_app/routers/
└── logs.py                    # 日志API路由 (新增)

web/src/
├── api/
│   └── logs.ts                # 日志API接口 (新增)
├── pages/
│   └── Logs/
│       └── index.tsx          # 日志查看页面 (新增)
├── routes/
│   └── index.tsx              # 路由配置 (已更新)
└── layouts/
    └── BasicLayout.tsx        # 菜单配置 (已更新)
```

### 日志查看功能特性

#### 1. 日志筛选
- ✅ 按日志级别筛选（DEBUG/INFO/WARNING/ERROR/CRITICAL）
- ✅ 关键字搜索（支持消息和事件字段）
- ✅ 日志文件切换
- ✅ 清空筛选按钮

#### 2. 日志展示
- ✅ 时间戳格式化显示
- ✅ 日志级别彩色标签
- ✅ 事件类型标签
- ✅ 附加数据（extra fields）展示
- ✅ 响应式表格布局

#### 3. 实用功能
- ✅ 自动刷新开关（每5秒）
- ✅ 手动刷新按钮
- ✅ 日志导出（.txt格式）
- ✅ 分页支持（50/100/200/500条/页）
- ✅ 总计数显示

### 日志格式支持

支持两种日志格式：

1. **JSON格式**（structlog输出）
```json
{
  "timestamp": "2025-10-20T07:22:29.993135Z",
  "level": "info",
  "message": "这是文件输出测试",
  "event": "test_file_output"
}
```

2. **普通文本格式**
```
2025-10-20 15:30:45 INFO: message
```

### API端点

- `GET /api/logs/list` - 获取日志列表（分页、筛选）
- `GET /api/logs/files` - 获取日志文件列表
- `GET /api/logs/stream` - 实时日志流（SSE）

### 使用说明

1. **访问日志页面**：点击侧边栏"日志查看"菜单
2. **切换日志文件**：从顶部下拉菜单选择不同的日志文件
3. **筛选日志**：使用级别筛选器和搜索框过滤日志
4. **自动刷新**：开启右上角的自动刷新开关
5. **导出日志**：点击导出按钮下载当前页日志

---

## 📋 Phase 3: 交易历史详情 ✅ (已完成)

### 已完成功能

1. **后端交易历史API** (`src/fastapi_app/routers/trades.py`)
   - 交易历史列表查询（支持分页）
   - 交易对列表
   - 交易统计信息
   - 多维度筛选（交易对、方向、时间范围）
   - 按日统计数据

2. **前端交易历史页面** (`web/src/pages/Trades/index.tsx`)
   - 交易记录表格展示
   - 交易统计卡片（总交易次数、总盈亏、胜率、平均盈亏）
   - 交易对筛选器
   - 买卖方向筛选
   - 时间范围选择器
   - 交易详情弹窗
   - CSV导出功能

3. **路由和菜单集成**
   - 添加 `/trades` 路由
   - 侧边栏菜单新增"交易历史"项

### 文件结构

```
src/fastapi_app/routers/
└── trades.py                  # 交易历史API路由 (新增)

web/src/
├── api/
│   └── trades.ts              # 交易历史API接口 (新增)
├── pages/
│   └── Trades/
│       └── index.tsx          # 交易历史页面 (新增)
├── routes/
│   └── index.tsx              # 路由配置 (已更新)
└── layouts/
    └── BasicLayout.tsx        # 菜单配置 (已更新)
```

### 交易历史功能特性

#### 1. 交易筛选
- ✅ 按交易对筛选（显示每个交易对的交易次数）
- ✅ 按买卖方向筛选
- ✅ 按时间范围筛选（支持精确到秒）
- ✅ 清空筛选按钮

#### 2. 交易展示
- ✅ 时间格式化显示
- ✅ 交易对标签
- ✅ 买卖方向彩色标签
- ✅ 价格、数量、成交额
- ✅ 盈亏彩色显示
- ✅ 手续费显示
- ✅ 响应式表格布局

#### 3. 统计信息
- ✅ 总交易次数
- ✅ 总盈亏（USDT）
- ✅ 胜率百分比
- ✅ 平均每笔盈亏
- ✅ 买入/卖出次数统计
- ✅ 总手续费统计
- ✅ 总交易量统计

#### 4. 交易详情
- ✅ 详情弹窗展示完整交易信息
- ✅ 订单ID显示
- ✅ 备注信息显示
- ✅ 格式化展示所有字段

#### 5. 数据导出
- ✅ CSV格式导出
- ✅ 支持中文（UTF-8 BOM）
- ✅ 导出当前筛选结果
- ✅ 包含所有关键字段

### API端点

- `GET /api/trades/list` - 获取交易历史列表（分页、筛选）
- `GET /api/trades/symbols` - 获取有交易记录的交易对
- `GET /api/trades/statistics` - 获取交易统计信息

### 使用说明

1. **访问交易历史**：点击侧边栏"交易历史"菜单
2. **查看统计**：页面顶部显示总交易次数、总盈亏、胜率等关键指标
3. **筛选交易**：使用交易对、方向、时间范围筛选器过滤交易记录
4. **查看详情**：点击操作列的"详情"按钮查看完整交易信息
5. **导出数据**：点击导出按钮下载CSV格式的交易记录

---

## 📋 Phase 4: SSE实时数据推送 ✅ (已完成)

### 已完成功能

1. **SSE Hook** (`web/src/hooks/useSSE.ts`)
   - EventSource连接管理
   - 自动重连机制（可配置间隔和最大次数）
   - 连接状态管理（connecting/connected/disconnected/error）
   - 错误处理和回调

2. **SSE状态指示器** (`web/src/components/SSEStatusIndicator.tsx`)
   - 实时连接状态显示
   - 彩色状态标签
   - 重连次数显示
   - Tooltip提示信息

3. **后端SSE支持**
   - 更新依赖项支持URL参数认证 (`src/fastapi_app/dependencies.py`)
   - 修改SSE路由支持token查询参数 (`src/fastapi_app/routers/sse.py`)

4. **Home页面集成**
   - SSE实时数据更新
   - 连接状态显示
   - 实时推送开关
   - 智能轮询（SSE连接时60秒，未连接时10秒）

### 文件结构

```
src/fastapi_app/
├── dependencies.py            # 依赖项 (已更新 - 添加URL参数认证)
└── routers/
    └── sse.py                 # SSE路由 (已更新 - 支持token参数)

web/src/
├── hooks/
│   └── useSSE.ts              # SSE Hook (新增)
├── components/
│   └── SSEStatusIndicator.tsx # SSE状态指示器 (新增)
└── pages/
    └── Home/
        └── index.tsx          # 首页 (已更新 - 集成SSE)
```

### SSE功能特性

#### 1. 连接管理
- ✅ 自动建立EventSource连接
- ✅ 自动重连（可配置间隔：默认3秒）
- ✅ 最大重连次数限制（默认10次）
- ✅ 连接状态实时监控

#### 2. 状态显示
- ✅ 4种连接状态（连接中/已连接/断开/错误）
- ✅ 彩色状态标签
- ✅ 重连次数显示
- ✅ 详细错误信息提示

#### 3. 消息处理
- ✅ 自动解析JSON消息
- ✅ 事件类型路由
- ✅ 数据更新触发
- ✅ 配置���新通知

#### 4. 用户控制
- ✅ 实时推送开关
- ✅ 手动刷新按钮
- ✅ 最后更新时间显示
- ✅ 智能轮询策略

### SSE事件类型

当前支持的SSE事件：
- `connected` - 连接建立
- `dashboard_update` - 仪表盘数据更新
- `config_updated` - 配置更新通知

### 使用说明

1. **启用SSE**：Home页面顶部可看到实时推送开关
2. **查看状态**：状态指示器显示当前连接状态
3. **重连控制**：连接失败会自动重连，最多尝试10次
4. **关闭SSE**：可手动关闭实时推送，系统将使用定时轮询

---

## 📋 Phase 5: 移动端响应式优化 ✅ (已完成)

### 已完成功能

1. **Home页面响应式布局**
   - 核心指标卡片：xs=24, sm=12, lg=6（移动端单列，平板双列，桌面四列）
   - 系统状态卡片：xs=24, lg=12（移动端单列，桌面双列）
   - 图表区域：全宽自适应
   - SSE控制栏：自动换行

2. **���表组件响应式**
   - 自动检测屏幕宽度
   - 移动端（<576px）：最高250px
   - 平板（576-768px）：最高280px
   - 桌面（>768px）：原始高度
   - 窗口大小变化自动调整

3. **表格响应式**
   - 横向滚动支持（`scroll={{ x: 'max-content' }}`）
   - 小尺寸表格（`size="small"`）
   - 自动换行支持

### 响应式断点

遵循Ant Design默认断点：
- `xs`: <576px（手机）
- `sm`: ≥576px（大手机/小平板）
- `md`: ≥768px（平板）
- `lg`: ≥992px（桌面）
- `xl`: ≥1200px（大桌面）
- `xxl`: ≥1600px（超大桌面）

### 优化效果

#### 移动端（手机）
- ✅ 单列布局，充分利用屏幕宽度
- ✅ 图表高度缩减，减少滚动
- ✅ 控制栏自动换行
- ✅ 表格横向滚动

#### 平板端
- ✅ 双列布局，平衡显示
- ✅ 适中图表高度
- ✅ 更好的触摸体验

#### 桌面端
- ✅ 多列布局，信息密度高
- ✅ 完整图表显示
- ✅ 最佳浏览体验

### 文件修改

```
web/src/
├── pages/
│   └── Home/index.tsx         # 首页 (已更新 - 响应式布局)
└── components/
    └── charts/
        ├── ProfitTrendChart.tsx    # 盈亏趋势图 (已更新 - 响应式高度)
        ├── TradeVolumeChart.tsx    # 交易量图 (已更新 - 响应式高度)
        └── PositionPieChart.tsx    # 仓位分布图 (已更新 - 响应式高度)
```

---

## 🔄 下一步建议

### 后端增强
- [ ] 实现真实的历史数据API（替换模拟数据）
- [ ] 添加SSE心跳保持机制
- [ ] 实现更多SSE事件类型（交易通知、风险警告等）
- [ ] 添加数据库存储交易历史

### 前端增强
- [ ] 添加PWA支持（离线访问）
- [ ] 实现图表数据导出功能
- [ ] 添加更多图表类型（K线图、深度图等）
- [ ] 实现暗色模式自动切换（跟随系统）
- [ ] 添加通知提醒功能

### 性能优化
- [ ] 实现虚拟滚动（大数据量表格）
- [ ] 添加图表数据采样（性能优化）
- [ ] 实现懒加载和代码分割
- [ ] 优化SSE重连策略

---

## 🐛 故障排查

### 图表不显示
1. 检查浏览器控制台是否有错误
2. 确认echarts依赖已安装：`npm list echarts`
3. 检查API数据是否正确返回

### 交易历史不显示
1. 确认交易器有交易记录：检查 `trader.trade_history`
2. 确认用户已登录（交易历史API需要认证）
3. 查看浏览器控制台错误信息
4. 检查后端日志是否有错误

### CSV导出乱码
- 已添加UTF-8 BOM，如仍有问题，使用Excel打开时选择UTF-8编码

### SSE连接失败
1. 确认后端服务正常运行
2. 检查浏览器控制台错误信息
3. 确认用户token有效
4. 查看SSE endpoint是否可访问：`GET /api/sse/events?token=<token>`

### 实时推送不工作
1. 检查SSE开关是否开启
2. 查看连接状态指示器
3. 检查浏览器是否支持EventSource
4. 查看后端SSE日志

### 日志页面空白
1. 确认后端服务正常运行：`GET /api/health`
2. 检查日志文件是否存在：`logs/gridbnb.log`
3. 确认用户已登录（日志API需要认证）
4. 查看浏览器控制台错误信息

### 日志不更新
1. 检查自动刷新开关是否开启
2. 确认日志文件有新内容写入
3. 手动点击刷新按钮测试

### 主题切换后图表颜色不变
- 图表组件会自动监听主题变化，如果没有更新，刷新页面即可

### 构建失败
```bash
# 清除缓存重新安装
rm -rf node_modules package-lock.json
npm install
npm run build
```

---

## 📖 技术栈

- **React 19** - UI框架
- **TypeScript** - 类型安全
- **Vite** - 构建工具
- **Ant Design 5** - UI组件库
- **ECharts 5** - 图表库
- **React Router 7** - 路由管理

---

**更新时间**: 2025-11-03
**状态**: Phase 1-5 全部完成 ✅
